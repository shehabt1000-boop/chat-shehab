<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Shehab Academy - شات متقدم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      color: #111;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: center;
      overflow: hidden;
      direction: rtl;
    }
    /* شاشة تسجيل الدخول */
    #loginScreen {
      width: 90%;
      max-width: 400px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #loginScreen h2 {
      margin-bottom: 20px;
    }
    #loginScreen input, #loginScreen select, #loginScreen button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    #loginMsg {
      color: #d00;
      margin-top: 5px;
      min-height: 20px;
      text-align: center;
    }

    /* شاشة الشات */
    #app {
      display: none;
      width: 95vw;
      max-width: 900px;
      height: 90vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* القائمة الجانبية - المتصلين */
    #sidebar {
      width: 250px;
      border-left: 1px solid #ddd;
      background: #fafafa;
      padding: 12px 10px;
      display: flex;
      flex-direction: column;
    }
    #sidebar h3 {
      margin: 0 0 12px 0;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
    }
    #usersList {
      flex: 1;
      overflow-y: auto;
    }
    .userItem {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      cursor: default;
    }
    .userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }
    .userName {
      flex: 1;
      font-weight: 600;
      font-size: 16px;
    }
    .onlineDot {
      width: 12px;
      height: 12px;
      background: #2ecc71;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 6px #2ecc71aa;
    }

    /* المنطقة الرئيسية للشات */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #chatHeader {
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2d8cff;
      color: white;
    }
    #chatHeader button {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      background: #f7f8fb;
      padding: 12px 16px;
    }
    .msg {
      margin-bottom: 14px;
      padding: 10px 14px;
      background: #fff;
      border-radius: 8px;
      word-break: break-word;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      position: relative;
    }
    .msg .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }
    .msgContent {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .msgHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .msgUser {
      font-weight: bold;
      font-size: 16px;
      color: #222;
    }
    .msgTime {
      font-size: 12px;
      color: #666;
      margin-left: 8px;
      white-space: nowrap;
    }
    .msgText {
      font-size: 15px;
      white-space: pre-wrap;
      color: #333;
    }
    .actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    .action-btn {
      cursor: pointer;
      font-size: 14px;
      color: #2d8cff;
      user-select: none;
      background: none;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .action-btn:hover {
      background: #dbe7ff;
      text-decoration: none;
    }

    /* منطقة الإدخال */
    #inputBar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid #ddd;
      background: #fff;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      resize: none;
      font-size: 16px;
      height: 60px;
    }
    #sendBtn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #2d8cff;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    /* Responsive للموبايل */
    @media (max-width: 700px) {
      body {
        align-items: flex-start;
        padding: 12px;
      }
      #app {
        flex-direction: column;
        width: 100vw;
        height: 100vh;
        border-radius: 0;
      }
      #sidebar {
        width: 100%;
        height: 120px;
        border-left: none;
        border-top: 1px solid #ddd;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 10px 6px;
      }
      #sidebar h3 {
        display: none;
      }
      #usersList {
        display: flex;
        gap: 12px;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .userItem {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-width: 70px;
        padding: 6px 0;
        border-bottom: none;
      }
      .userAvatar {
        width: 48px;
        height: 48px;
      }
      #main {
        height: calc(100vh - 120px);
      }
    }
  </style>
</head>
<body>

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen">
  <h2>تسجيل دخول Shehab Academy</h2>
  <input id="username" placeholder="اكتب اسمك" autocomplete="off" />
  <select id="gender">
    <option value="" disabled selected>اختر جنسك</option>
    <option value="male">ذكر</option>
    <option value="female">أنثى</option>
  </select>
  <button id="loginBtn">دخول الشات</button>
  <div id="loginMsg"></div>
</div>

<!-- شاشة الشات -->
<div id="app">
  <div id="main">
    <div id="chatHeader">
      <div>Shehab Academy - الشات</div>
      <button id="logoutBtn">تسجيل خروج</button>
    </div>
    <div id="messages"></div>
    <div id="inputBar">
      <textarea id="messageInput" placeholder="اكتب رسالة..." rows="2"></textarea>
      <button id="sendBtn">إرسال</button>
    </div>
  </div>
  <div id="sidebar">
    <h3>المتصلون</h3>
    <div id="usersList"></div>
  </div>
</div>

<script>
  // بيانات المستخدم الحالي
  let currentUser = null;

  // العناصر DOM
  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');

  const usernameInput = document.getElementById('username');
  const genderSelect = document.getElementById('gender');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');

  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const usersListDiv = document.getElementById('usersList');

  // قاعدة بيانات وهمية لتخزين المستخدمين والرسائل (في الذاكرة)
  // **ملاحظة:** عند تحديث الصفحة تُفقد البيانات لأن هذا مثال بسيط بدون سيرفر
  const db = {
    users: {}, // المفتاح: id عشوائي، القيمة: بيانات المستخدم
    messages: [] // مصفوفة الرسائل
  };

  // دالة لتوليد معرف فريد عشوائي
  function generateId() {
    return Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
  }

  // دالة للحصول على صورة عشوائية حسب الجنس
  function getRandomAvatar(name, gender) {
    // نستخدم تجزئة الاسم للحصول على رقم ثابت
    let num = hashCode(name) % 100;
    if (gender === 'female') {
      return `https://randomuser.me/api/portraits/women/${num}.jpg`;
    } else {
      return `https://randomuser.me/api/portraits/men/${num}.jpg`;
    }
  }

  // دالة مساعدة لتوليد رقم من نص (hash)
  function hashCode(str) {
    let hash = 0;
    for(let i=0; i < str.length; i++){
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
      hash = hash & hash; // 32-bit integer
    }
    return Math.abs(hash);
  }

  // حدث دخول المستخدم
  loginBtn.addEventListener('click', () => {
    const name = usernameInput.value.trim();
    const gender = genderSelect.value;
    if (!name) {
      loginMsg.textContent = 'الرجاء كتابة اسم المستخدم';
      return;
    }
    if (!gender) {
      loginMsg.textContent = 'الرجاء اختيار الجنس';
      return;
    }
    loginMsg.textContent = '';

    // إنشاء المستخدم الحالي
    const userId = generateId();
    currentUser = { id: userId, name, gender, online: true, avatar: getRandomAvatar(name, gender) };
    db.users[userId] = currentUser;

    // إظهار الشات وإخفاء تسجيل الدخول
    loginScreen.style.display = 'none';
    app.style.display = 'flex';

    renderUsers();
    renderMessages();
    updateSendBtnState();
    messageInput.focus();
  });

  // حدث تسجيل خروج
  logoutBtn.addEventListener('click', () => {
    if (confirm('هل تريد تسجيل الخروج؟')) {
      if(currentUser && db.users[currentUser.id]) {
        delete db.users[currentUser.id];
      }
      currentUser = null;

      loginScreen.style.display = 'flex';
      app.style.display = 'none';

      // تنظيف واجهة المستخدم
      messagesDiv.innerHTML = '';
      usersListDiv.innerHTML = '';
      usernameInput.value = '';
      genderSelect.value = '';
      loginMsg.textContent = '';
      messageInput.value = '';
    }
  });

  // عرض قائمة المستخدمين المتصلين
  function renderUsers() {
    usersListDiv.innerHTML = '';
    Object.values(db.users).forEach(user => {
      const div = document.createElement('div');
      div.classList.add('userItem');

      const img = document.createElement('img');
      img.src = user.avatar;
      img.alt = user.name;
      img.classList.add('userAvatar');

      const nameSpan = document.createElement('span');
      nameSpan.textContent = user.name;
      nameSpan.classList.add('userName');

      const onlineDot = document.createElement('div');
      onlineDot.classList.add('onlineDot');
      onlineDot.title = 'متصل الآن';

      div.appendChild(img);
      div.appendChild(nameSpan);
      div.appendChild(onlineDot);

      usersListDiv.appendChild(div);
    });
  }

  // عرض الرسائل
  function renderMessages() {
    messagesDiv.innerHTML = '';
    db.messages.forEach(msg => {
      addMessageToDOM(msg);
    });
    scrollToBottom();
  }

  // دالة لإضافة رسالة إلى DOM
  function addMessageToDOM(msg) {
    const msgEl = document.createElement('div');
    msgEl.classList.add('msg');

    const avatar = document.createElement('img');
    avatar.classList.add('avatar');
    avatar.src = msg.user.avatar;
    avatar.alt = msg.user.name;

    const content = document.createElement('div');
    content.classList.add('msgContent');

    const header = document.createElement('div');
    header.classList.add('msgHeader');

    const userSpan = document.createElement('span');
    userSpan.classList.add('msgUser');
    userSpan.textContent = msg.user.name;

    const timeSpan = document.createElement('span');
    timeSpan.classList.add('msgTime');
    timeSpan.textContent = new Date(msg.timestamp).toLocaleTimeString('ar-EG');

    header.appendChild(userSpan);
    header.appendChild(timeSpan);

    // أزرار تعديل وحذف فقط للرسائل الخاصة بالمستخدم الحالي
    if (currentUser && currentUser.id === msg.user.id) {
      const actionsDiv = document.createElement('div');
      actionsDiv.classList.add('actions');

      const editBtn = document.createElement('button');
      editBtn.classList.add('action-btn');
      editBtn.textContent = 'تعديل';
      editBtn.onclick = () => {
        const newText = prompt('عدل رسالتك:', msg.text);
        if (newText !== null && newText.trim() !== '' && newText.trim() !== msg.text) {
          msg.text = newText.trim();
          msg.edited = true;
          renderMessages();
        }
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('action-btn');
      deleteBtn.textContent = 'حذف';
      deleteBtn.onclick = () => {
        if(confirm('هل تريد حذف هذه الرسالة؟')){
          db.messages = db.messages.filter(m => m !== msg);
          renderMessages();
        }
      };

      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(deleteBtn);
      header.appendChild(actionsDiv);
    }

    const textDiv = document.createElement('div');
    textDiv.classList.add('msgText');
    textDiv.textContent = msg.edited ? msg.text + ' (معدل)' : msg.text;

    content.appendChild(header);
    content.appendChild(textDiv);

    msgEl.appendChild(avatar);
    msgEl.appendChild(content);

    messagesDiv.appendChild(msgEl);
  }

  // إرسال رسالة
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    if (!currentUser) return;
    const text = messageInput.value.trim();
    if (!text) return;
    const msg = {
      user: currentUser,
      text,
      timestamp: Date.now(),
      edited: false,
      id: generateId()
    };
    db.messages.push(msg);
    renderMessages();
    messageInput.value = '';
    updateSendBtnState();
    scrollToBottom();
  }

  function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // تفعيل/تعطيل زر الإرسال حسب محتوى النص
  function updateSendBtnState() {
    sendBtn.disabled = messageInput.value.trim() === '';
  }
  messageInput.addEventListener('input', updateSendBtnState);

  // عندما تفتح الصفحة لأول مرة نعرض صفحة تسجيل الدخول فقط
  window.onload = () => {
    loginScreen.style.display = 'flex';
    app.style.display = 'none';
    updateSendBtnState();
  };
</script>

</body>
</html>
